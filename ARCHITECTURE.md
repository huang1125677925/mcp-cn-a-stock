# 中国股市数据MCP服务架构分析文档

## 项目概述

这是一个专为A股市场数据设计的MCP (Model Content Protocol) 服务，为大模型提供股票数据查询和分析能力。项目通过标准化的MCP协议，使AI助手能够获取和分析中国股市的实时和历史数据。

## 整体架构

### 架构模式
- **MCP服务器模式**: 基于FastMCP框架构建的标准化AI工具服务
- **分层架构**: 清晰的职责分离，包含数据层、服务层、接口层
- **模块化设计**: 各功能模块独立，便于维护和扩展

### 技术栈
- **核心框架**: FastMCP (基于mcp.server.fastmcp)
- **数据获取**: 自定义qtf库 + MSD数据源
- **数据处理**: NumPy + Ta-Lib (技术指标)
- **配置管理**: JSON配置文件
- **部署方式**: Python CLI应用 + SSE/HTTP传输

## 模块架构详解

### 1. 入口层 (main.py)

**职责**: 应用程序入口，处理命令行参数和启动服务

**核心功能**:
- 命令行参数解析 (端口、传输方式)
- 日志配置
- 股票符号预加载
- MCP服务启动

**配置选项**:
```bash
python main.py --port 8000 --transport sse
```

### 2. MCP服务层 (qtf_mcp/mcp_app.py)

**职责**: MCP协议实现，定义AI可调用的工具接口

**核心组件**:
- **FastMCP实例**: `CnStock`服务
- **工具定义**: 三个级别的数据查询工具
- **路由配置**: SSE、HTTP、消息接口路径

**工具接口**:

| 工具名称 | 功能描述 | 数据范围 |
|---------|----------|----------|
| `brief` | 基础信息查询 | 基本信息 + 交易数据 |
| `medium` | 中等深度分析 | brief数据 + 财务数据 |
| `full` | 全面技术分析 | medium数据 + 技术指标 |

**请求格式**:
```json
{
  "symbol": "SH000001"
}
```

### 3. 数据服务层 (qtf_mcp/datafeed.py)

**职责**: 数据获取、清洗、标准化处理

**数据源架构**:
- **MSD数据源**: 基于msd://协议的专业金融数据服务
- **数据类型**: K线、财务、分红、资金流向
- **更新频率**: 日线数据(1d)、季度财务(1q)

**核心类/函数**:
- `load_data_msd()`: 单股票数据获取
- `load_data_msd_batch()`: 批量数据获取
- `align_date_fill()`: 日期对齐算法
- `symbol_sqls()`: SQL查询构建

**数据处理流程**:
1. **原始数据获取**: 从MSD服务拉取多维度数据
2. **数据对齐**: 处理不同频率数据的时间对齐
3. **财务数据处理**: 单位转换、复权计算
4. **分红处理**: 前复权价格计算
5. **行业映射**: 基于配置文件的sector映射

**数据维度**:
- **K线数据**: OHLCV、复权价格
- **财务数据**: 市值、净资产、收益率等
- **资金流向**: 主力、超大单、大单等
- **分红数据**: 送股、派息、配股

### 4. 研究分析层 (qtf_mcp/research.py)

**职责**: 数据分析和报告生成

**核心功能模块**:
- **数据加载**: `load_raw_data()` - 获取2年历史数据
- **报告构建器**: 分层级的数据报告生成
- **技术指标**: 基于Ta-Lib的专业指标计算

**报告构建器**:
- `build_basic_data()`: 基本信息展示
- `build_trading_data()`: 交易数据分析
- `build_financial_data()`: 财务指标分析
- `build_technical_data()`: 技术指标计算

**技术指标**:
- **趋势指标**: MACD信号
- **动量指标**: KDJ随机指标
- **波动率**: 多周期振幅分析
- **成交量**: 量比、均量分析

**报告格式**:
采用Markdown格式，包含：
- 结构化标题和列表
- 数值格式化展示
- 多空判断标识
- 行业概念标签过滤

### 5. 符号管理层 (qtf_mcp/symbols.py)

**职责**: 股票代码管理和映射

**数据结构**:
- `SYMBOLS_SHSZ`: 股票代码到名称的映射字典
- **配置源**: `confs/markets.json` - 包含5000+股票代码

**核心功能**:
- `load_symbols()`: 从配置文件加载股票列表
- `symbol_with_name()`: 代码到名称的转换
- `get_symbol_name()`: 单股票名称查询

### 6. 配置管理层

**配置文件结构**:

#### markets.json
- **用途**: 股票基础信息配置
- **内容**: 股票代码、名称、分类
- **规模**: 5000+股票记录
- **示例**:
```json
{
  "items": [
    {
      "code": "SH000001",
      "name": "上证指数",
      "kind": "上证指数"
    }
  ]
}
```

#### stock_sector.json
- **用途**: 股票行业概念映射
- **格式**: 代码到行业列表的映射
- **作用**: 提供行业分析维度

## 数据流架构

### 请求处理流程

```
用户查询 → MCP客户端 → FastMCP服务 → 工具选择 → 数据获取 → 分析处理 → 报告返回
```

### 详细流程

1. **请求接收**: MCP客户端发送symbol参数
2. **工具路由**: 根据工具类型(brief/medium/full)选择处理逻辑
3. **数据获取**: 
   - 调用`load_raw_data()`获取2年原始数据
   - 通过`load_data_msd()`从MSD服务拉取数据
4. **数据处理**:
   - 数据清洗和标准化
   - 技术指标计算
   - 财务比率计算
5. **报告生成**: 按层级构建Markdown格式报告
6. **响应返回**: 通过MCP协议返回结构化文本

## 部署架构

### 运行模式
- **开发模式**: 本地运行，支持stdio/sse/http传输
- **生产模式**: 服务器部署，SSE/HTTP接口

### 环境要求
- **Python**: >=3.12
- **依赖**: qtf库、Ta-Lib、MCP框架
- **数据源**: MSD服务访问权限

### 启动脚本
```bash
# 开发启动
python main.py --port 8000 --transport sse

# 测试脚本
./tests/test.sh
```

## 扩展性设计

### 模块化优势
- **新增工具**: 可在mcp_app.py中简单添加新工具
- **数据源扩展**: 通过修改datafeed.py支持新数据源
- **指标扩展**: 在research.py中添加新分析维度

### 配置扩展
- **股票列表**: 通过markets.json动态扩展
- **行业映射**: 通过stock_sector.json维护行业关系

## 性能优化

### 数据缓存
- **预加载**: 启动时加载股票符号映射
- **批量获取**: 支持多股票并行数据拉取
- **内存优化**: NumPy数组的高效内存使用

### 计算优化
- **向量化计算**: NumPy/Ta-Lib的向量化操作
- **延迟计算**: 按需计算技术指标
- **数据复用**: 多工具间共享基础数据

## 安全考虑

### 数据安全
- **访问控制**: 基于客户端IP的访问日志
- **数据脱敏**: 不涉及敏感个人信息
- **权限管理**: 只读数据访问模式

### 接口安全
- **传输安全**: 支持HTTPS部署
- **限流机制**: 可通过MCP框架配置
- **输入验证**: 股票代码格式验证

## 监控和运维

### 日志系统
- **访问日志**: 记录客户端IP和查询股票
- **性能日志**: 数据获取时间统计
- **错误日志**: 异常捕获和记录

### 健康检查
- **服务状态**: MCP服务心跳检测
- **数据源**: MSD服务连接状态
- **配置加载**: 配置文件完整性检查

## 使用场景

### 适用用户
- **量化交易者**: 快速获取股票分析报告
- **AI助手**: 集成股票分析能力
- **金融分析师**: 批量股票数据获取
- **教育用途**: 学习股票数据分析

### 集成示例
- **CherryStudio**: 图形化MCP客户端
- **DeepChat**: 对话式AI集成
- **自定义客户端**: 基于MCP协议的API调用

## 总结

本项目采用了现代化的MCP协议架构，通过分层设计实现了高效、可扩展的A股数据服务。其模块化设计使得系统易于维护和扩展，同时标准化的MCP协议保证了与各种AI客户端的兼容性。该架构特别适合需要快速集成股票数据能力的AI应用场景。