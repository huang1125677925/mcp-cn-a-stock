# 中国股市数据MCP服务架构分析文档

## 项目概述

这是一个专为A股市场数据设计的MCP (Model Content Protocol) 服务，为大模型提供股票数据查询和分析能力。项目通过标准化的MCP协议，使AI助手能够获取和分析中国股市的实时和历史数据。

## 整体架构

### 架构模式
- **MCP服务器模式**: 基于FastMCP框架构建的标准化AI工具服务
- **分层架构**: 清晰的职责分离，包含数据层、服务层、接口层
- **模块化设计**: 各功能模块独立，便于维护和扩展

### 技术栈
- **核心框架**: FastMCP (基于mcp.server.fastmcp)
- **数据获取**: AkShare金融数据接口 + 本地配置文件
- **数据处理**: NumPy + Ta-Lib (技术指标)
- **配置管理**: JSON配置文件
- **部署方式**: Python CLI应用 + SSE/HTTP传输

## 模块架构详解

### 1. 入口层 (main.py)

**职责**: 应用程序入口，处理命令行参数和启动服务

**核心功能**:
- 命令行参数解析 (端口、传输方式)
- 日志配置
- 股票符号预加载
- MCP服务启动

**配置选项**:
```bash
python main.py --port 8000 --transport sse
```

### 2. MCP服务层 (qtf_mcp/mcp_app.py)

**职责**: MCP协议实现，定义AI可调用的工具接口

**核心组件**:
- **FastMCP实例**: `CnStock`服务
- **工具定义**: 三个级别的数据查询工具
- **路由配置**: SSE、HTTP、消息接口路径

**工具接口**:

| 工具名称 | 功能描述 | 数据范围 |
|---------|----------|----------|
| `brief` | 基础信息查询 | 基本信息 + 交易数据 |
| `medium` | 中等深度分析 | brief数据 + 财务数据 |
| `full` | 全面技术分析 | medium数据 + 技术指标 |
| `latest_trading` | 最新交易数据 | 实时价格 + 涨跌幅 + 成交数据 |

**请求格式**:
```json
{
  "symbol": "SH600276"
}
```

### 3. 数据服务层 (qtf_mcp/datafeed.py)

**职责**: 数据获取、清洗、标准化处理

**数据源架构**:
- **AkShare数据源**: 基于akshare库的免费金融数据接口
- **数据类型**: K线、财务、资金流向、股票基本信息
- **更新频率**: 日线数据、实时资金流向

**核心类/函数**:
- `fetch_kline_data()`: 获取K线历史数据
- `fetch_finance_data()`: 获取股票基本信息和财务数据
- `fetch_fundflow_data()`: 获取资金流向数据
- `fetch_individual_info()`: 获取个股基本信息

**数据处理流程**:
1. **原始数据获取**: 从AkShare接口拉取多维度数据
2. **数据清洗**: 处理缺失值、异常值
3. **单位转换**: 财务数据单位标准化（元/万元/亿元）
4. **数据合并**: 整合多源数据为统一格式

**数据维度**:
- **K线数据**: OHLCV、复权价格、成交量
- **财务数据**: 总市值、流通市值、总股本、流通股本
- **资金流向**: 主力、超大单、大单、中单、小单净流入
- **基本信息**: 股票名称、行业、概念等

### 4. 研究分析层 (qtf_mcp/research.py)

**职责**: 数据分析和报告生成

**核心功能模块**:
- **数据加载**: `load_raw_data()` - 获取历史数据
- **报告构建器**: 分层级的数据报告生成
- **技术指标**: 基于Ta-Lib的专业指标计算

**报告构建器**:
- `build_basic_data()`: 基本信息展示（股票名称、代码、市值）
- `build_trading_data()`: 交易数据分析（价格、成交量、涨跌幅）
- `build_financial_data()`: 财务指标分析（市值、股本结构）
- `build_technical_data()`: 技术指标计算（MACD、KDJ、RSI等）

**技术指标**:
- **趋势指标**: MACD信号、均线系统
- **动量指标**: KDJ随机指标、RSI相对强弱指标
- **波动率**: 多周期振幅分析
- **成交量**: 量比、均量分析

**报告格式**:
采用Markdown格式，包含：
- 结构化标题和列表
- 数值格式化展示
- 多空判断标识
- 完整的市场数据概览

### 5. 符号管理层 (qtf_mcp/symbols.py)

**职责**: 股票代码管理和映射

**数据结构**:
- **配置源**: `confs/markets.json` - 包含6616个股票代码和名称映射
- **缓存机制**: 本地文件优先，缺失时实时获取
- **回退策略**: AkShare实时查询作为后备方案

**核心功能**:
- `load_markets_data()`: 从配置文件加载股票列表
- `get_symbol_name()`: 单股票名称查询
- `symbol_with_name()`: 代码到名称的批量转换
- **容错处理**: 配置文件缺失时从AkShare获取

**数据规模**:
- **股票数量**: 6616只股票（沪深京三市）
- **数据格式**: `{股票代码: 股票名称}`映射
- **更新机制**: 支持动态更新和缓存刷新

### 6. 配置管理层

**配置文件结构**:

#### markets.json
- **用途**: 股票基础信息配置
- **内容**: 股票代码、名称、市场类型
- **规模**: 6616股票记录
- **示例**:
```json
{
  "SH600276": "恒瑞医药",
  "SZ000001": "平安银行",
  "SH000001": "上证指数"
}
```

#### stock_sector.json
- **用途**: 股票行业概念映射
- **格式**: 代码到行业列表的映射
- **作用**: 提供行业分析维度

## 数据流架构

### 请求处理流程

```
用户查询 → MCP客户端 → FastMCP服务 → 工具选择 → 数据获取 → 分析处理 → 报告返回
```

### 详细流程

1. **请求接收**: MCP客户端发送symbol参数
2. **工具路由**: 根据工具类型(brief/medium/full)选择处理逻辑
3. **数据获取**: 
   - 调用`load_raw_data()`获取历史数据
   - 通过AkShare接口获取实时数据
4. **数据处理**:
   - 数据清洗和标准化
   - 技术指标计算
   - 市值单位换算（万元→亿元）
5. **报告生成**: 按层级构建Markdown格式报告
6. **响应返回**: 通过MCP协议返回结构化文本

### 关键修复和优化

#### 总市值计算修复
- **问题**: 原计算使用总股本×股价，导致市值显示错误（175494.77亿元）
- **修复**: 直接使用AkShare接口提供的TCAP字段（万元单位），除以10000转换为亿元
- **结果**: 恒瑞医药(SH600276)总市值正确显示为4183.43亿元

#### 股票名称管理优化
- **改进**: 从配置文件`confs/markets.json`加载6616个股票名称
- **机制**: 本地缓存 + 实时回退，提高查询效率和容错性
- **验证**: 支持沪深京三市股票代码到名称的准确映射

## 部署架构

### 运行模式
- **开发模式**: 本地运行，支持stdio/sse/http传输
- **生产模式**: 服务器部署，SSE/HTTP接口

### 环境要求
- **Python**: >=3.12
- **依赖**: akshare、pandas、numpy、Ta-Lib、mcp框架
- **数据源**: AkShare接口访问权限

### 启动脚本
```bash
# 开发启动
python main.py --port 8000 --transport sse

# 测试脚本
python test_full.py

# 符号管理测试
python test_symbols.py
```

### 安装依赖
```bash
pip install -r requirements.txt
```

## 扩展性设计

### 模块化扩展
- **新增数据源**: 可扩展支持多个金融数据接口
- **自定义指标**: 支持添加新的技术分析指标
- **配置灵活**: JSON配置文件支持动态调整

### 性能优化
- **缓存机制**: 减少重复API调用
- **批量查询**: 支持多股票批量数据获取
- **异步处理**: 可扩展为异步数据获取

### 数据源适配
- **AkShare**: 免费数据源，适合开发和测试
- **商业数据**: 可扩展支持Wind、同花顺等商业数据源
- **实时数据**: 支持Level-2行情和逐笔成交数据

## 使用示例

### 基础查询
```python
# 查询恒瑞医药基础信息
symbol = "SH600276"
# 返回：股票名称、最新价格、市值等基础数据
```

### 技术分析
```python
# 查询完整技术分析报告
# 包含：MACD、KDJ、RSI等技术指标
# 资金流向、行业对比等多维度分析
```

### 批量查询
```python
# 支持批量股票查询
symbols = ["SH600276", "SZ000001", "SH000001"]
# 返回多个股票的完整分析报告
```